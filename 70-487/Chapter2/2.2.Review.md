# Chapter 2

Querying and manipulating data with EntityFramework

## Part 1

Query/Manipulate data with EF

### Thought experiment

1. For a structure with a parent, five related children one of which with two grandchildren, it may be preferrable to lazy load the data, but the ultimate decision is going to rest on the size of that data compared to the number of possible roundtrips.

2. If you pull back all the data, you have space considerations to take into account.

3. If you lazy-load the data, you have network latency to consider.

4. The best approach will be determined by the level of knowledge about what you will do with the data - if a known number of queries will be required, then it could be better to load all at once, but if an unknown number, it could be better to lazy-load.

### Quiz

* 1.C FirstOrDefault causes a query to be executed
* 2.A/B If you try to add an entity that already exists, it is made if there is no key violation else it errors
* 3.D If you attach an entity to a context with an existing entity, it is updated.


## Part 2

Query & manipulate data using data provider for E.F.

### Thought experiment

1.  Using EntityProviders would help a transition from ADO.NET to EF.

2. The decision to move all code to EF could improve maintainability and future proof the solution.

3. Operations that are likely to be long-running are good candidates for asynchronous methods.

### Quiz

* 1.C ExecuteReaderAsync is for async operations
* 2.C/D You could use a transaction to mitigate problems from an overloaded DB
* 3.A/C Entity & SqlTransactions allow you to set a transaction scope.


## Part 3

Query data by using LINQ to Entities

### Thought experiment

1. You could diagnose the source of a problem with queries by using tracing the query and logging time taken by the server and in the database.

2. You could implement more logging and other features such as asynchronous methods for long running operations.

### Quiz

* 1.B/D You could use IQueryable and ObjectContext (which returns IQueryable) for a LINQ to EDM query.
* 2.A/B IEnumerable and IQueryable need to be implemented for something to be queried by LINQ


## Part 4

Query and manipulate data using ADO.net

### Thought experiment

1. One way to check whether there is a data leak related to open connections is to use inspecting tool to view open connections. You could also inspect the code to check connections are closed by wrapping in `using` statements or `try...catch...finally` statements.

2. To speed things up in a slow application, you could profile the application and find out where the long-runnign methods are taking place or other intensive operations and focus on optimising those parts.

### Quiz

* 1. B/C/D you could use a SqlAdapter or the SqlDataReader/ExecuteScalar to run a COUNT command
* 2.A SqlConnection objects should be opened as late as possible and closed as early as possible
* 3.C With a compiled query, the SQL translation is cached.


## Part 5

Create an Entity Framework data model

### Thought experiment

1. When moving a huge set of legacy code to EF, you could use entities to enable easier building of models. You could use the from-database designer to simplify much of the process.

2. You could use EF to populate the existing business object and the could simplify development, leaving in place code that is known to work.

### Quiz

* 1.A/B/C/D the SSDL, MSL & CSDL are all components of the EDM and are stored in the .edmx file
* 2.A/B in EF5+, the .ssdl and .msl files are consolidated into the .edmx file
* 3.C you can use the entity data model wizard to validate models in an ADO.net app